---
# Kubernetes role - Install kubectl, helm, k9s, and related tools

# ---------------------------------------------------------------------------------------------------------------------
# kubectl
# ---------------------------------------------------------------------------------------------------------------------

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes

- name: Download Kubernetes GPG key
  ansible.builtin.shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s_kubectl_major_version }}/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  become: yes

- name: Add Kubernetes repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_kubectl_major_version }}/deb/ /"
    state: present
    filename: kubernetes
  become: yes

- name: Install kubectl
  ansible.builtin.apt:
    name: kubectl
    state: present
    update_cache: yes
  become: yes

# ---------------------------------------------------------------------------------------------------------------------
# Helm
# ---------------------------------------------------------------------------------------------------------------------

- name: Check if Helm is installed
  ansible.builtin.command: helm version --short
  register: helm_check
  changed_when: false
  failed_when: false

- name: Download Helm installer script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '0755'
  become: yes
  when: helm_check.rc != 0

- name: Install Helm
  ansible.builtin.command: /tmp/get_helm.sh
  become: yes
  when: helm_check.rc != 0

- name: Clean up Helm installer
  ansible.builtin.file:
    path: /tmp/get_helm.sh
    state: absent
  become: yes

# ---------------------------------------------------------------------------------------------------------------------
# k9s
# ---------------------------------------------------------------------------------------------------------------------

- name: Check if k9s is installed
  ansible.builtin.stat:
    path: /usr/local/bin/k9s
  register: k9s_installed

- name: Download k9s
  ansible.builtin.get_url:
    url: "https://github.com/derailed/k9s/releases/download/v{{ k8s_k9s_version }}/k9s_Linux_amd64.tar.gz"
    dest: /tmp/k9s.tar.gz
    mode: '0644'
  become: yes
  when: not k9s_installed.stat.exists

- name: Extract k9s
  ansible.builtin.unarchive:
    src: /tmp/k9s.tar.gz
    dest: /tmp
    remote_src: yes
  become: yes
  when: not k9s_installed.stat.exists

- name: Install k9s
  ansible.builtin.copy:
    src: /tmp/k9s
    dest: /usr/local/bin/k9s
    mode: '0755'
    remote_src: yes
  become: yes
  when: not k9s_installed.stat.exists

- name: Clean up k9s archive
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  become: yes
  loop:
    - /tmp/k9s.tar.gz
    - /tmp/k9s
    - /tmp/LICENSE
    - /tmp/README.md

# ---------------------------------------------------------------------------------------------------------------------
# kubectx and kubens
# ---------------------------------------------------------------------------------------------------------------------

- name: Check if kubectx is installed
  ansible.builtin.stat:
    path: /usr/local/bin/kubectx
  register: kubectx_installed

- name: Download kubectx
  ansible.builtin.get_url:
    url: "https://github.com/ahmetb/kubectx/releases/download/v{{ k8s_kubectx_version }}/kubectx_v{{ k8s_kubectx_version }}_linux_x86_64.tar.gz"
    dest: /tmp/kubectx.tar.gz
    mode: '0644'
  become: yes
  when: not kubectx_installed.stat.exists

- name: Extract kubectx
  ansible.builtin.unarchive:
    src: /tmp/kubectx.tar.gz
    dest: /tmp
    remote_src: yes
  become: yes
  when: not kubectx_installed.stat.exists

- name: Install kubectx
  ansible.builtin.copy:
    src: /tmp/kubectx
    dest: /usr/local/bin/kubectx
    mode: '0755'
    remote_src: yes
  become: yes
  when: not kubectx_installed.stat.exists

- name: Download kubens
  ansible.builtin.get_url:
    url: "https://github.com/ahmetb/kubectx/releases/download/v{{ k8s_kubectx_version }}/kubens_v{{ k8s_kubectx_version }}_linux_x86_64.tar.gz"
    dest: /tmp/kubens.tar.gz
    mode: '0644'
  become: yes
  when: not kubectx_installed.stat.exists

- name: Extract kubens
  ansible.builtin.unarchive:
    src: /tmp/kubens.tar.gz
    dest: /tmp
    remote_src: yes
  become: yes
  when: not kubectx_installed.stat.exists

- name: Install kubens
  ansible.builtin.copy:
    src: /tmp/kubens
    dest: /usr/local/bin/kubens
    mode: '0755'
    remote_src: yes
  become: yes
  when: not kubectx_installed.stat.exists

- name: Clean up kubectx/kubens archives
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  become: yes
  loop:
    - /tmp/kubectx.tar.gz
    - /tmp/kubens.tar.gz
    - /tmp/kubectx
    - /tmp/kubens

# ---------------------------------------------------------------------------------------------------------------------
# Create kube config directory
# ---------------------------------------------------------------------------------------------------------------------

- name: Create .kube directory
  ansible.builtin.file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0700'
  become: yes

# ---------------------------------------------------------------------------------------------------------------------
# kubectl bash/zsh completion
# ---------------------------------------------------------------------------------------------------------------------

- name: Generate kubectl zsh completion
  ansible.builtin.shell: kubectl completion zsh > /home/ubuntu/.kubectl-completion.zsh
  become: yes
  become_user: ubuntu
  changed_when: false

- name: Add kubectl completion to zshrc
  ansible.builtin.blockinfile:
    path: /home/ubuntu/.zshrc
    block: |
      # kubectl completion
      source ~/.kubectl-completion.zsh
      alias k=kubectl
      complete -F __start_kubectl k
    marker: "# {mark} ANSIBLE MANAGED BLOCK - kubectl"
    create: yes
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: yes

# ---------------------------------------------------------------------------------------------------------------------
# Verify installations
# ---------------------------------------------------------------------------------------------------------------------

- name: Verify kubectl installation
  ansible.builtin.command: kubectl version --client
  register: kubectl_version
  changed_when: false

- name: Display kubectl version
  ansible.builtin.debug:
    msg: "{{ kubectl_version.stdout }}"

- name: Verify Helm installation
  ansible.builtin.command: helm version --short
  register: helm_version
  changed_when: false

- name: Display Helm version
  ansible.builtin.debug:
    msg: "{{ helm_version.stdout }}"

- name: Verify k9s installation
  ansible.builtin.command: k9s version --short
  register: k9s_version
  changed_when: false

- name: Display k9s version
  ansible.builtin.debug:
    msg: "{{ k9s_version.stdout }}"
